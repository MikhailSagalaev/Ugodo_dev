/**
 * @file: changelog.md
 * @description: Хронологический журнал всех изменений в проекте Ugodo.
 * @dependencies: N/A
 * @created: 2025-05-22
 */

## [2024-12-10] - Создание краткой инструкции по обновлению проекта
### Добавлено
- Создан файл `QUICK_UPDATE_GUIDE.md` с краткой инструкцией по обновлению проекта из GitHub
- Добавлены разделы о Docker и PM2 развертывании
- Включены инструкции по решению проблем с Git конфликтами
- Добавлен чек-лист обновления и экстренное восстановление
- Обновлена основная документация `README.md` со ссылкой на новую инструкцию

### Изменено
- Обновлена секция развертывания в `docs/project.md` с информацией об автоматизированных инструментах
- Добавлена информация о скриптах `deploy.sh`, `monitor.sh`, `fix-git-divergent.sh`
- Расширена документация по мониторингу и поддержке

### Исправлено
- (Нет исправлений в этом обновлении)

## [2024-07-31] - Рефакторинг SMS-авторизации/регистрации
### Изменено
- Улучшена обработка ошибок PerseidesJS (явное отображение ошибок типа 'Auth identity not found', 'Actor already exists' и др.)
- Улучшены пользовательские сообщения (UX copy) для всех сценариев
- Добавлено подробное логирование ошибок для отладки
- Покрыты все сценарии: регистрация, логин, несуществующий пользователь, ошибки сети и кода

### Исправлено
- Ошибки, из-за которых пользователь не видел причину неудачной отправки кода или неверного OTP

## [2024-08-05] - Документирование модуля авторизации по SMS OTP
### Добавлено
- Обновлена документация проекта с подробным описанием модуля `auth-phone-otp` для аутентификации через SMS-коды.
- Добавлено описание API-эндпоинтов для SMS OTP аутентификации в раздел API-документации.
- Добавлена информация о провайдере SMSC.ru для отправки SMS и его настройке через переменные окружения.

### Изменено
- Обновлена архитектурная диаграмма проекта с включением компонента аутентификации.
- Расширен технологический стек с указанием SMSC.ru как SMS-провайдера.

### Исправлено
- Интегрирован модуль SMS OTP аутентификации в общую документацию проекта для обеспечения целостности описания системы.

## [2025-05-30] - Улучшение модуля SMS OTP: тестовый режим без отправки SMS
### Добавлено
- В модуль `auth-phone-otp` (`service.ts`) добавлена поддержка тестового режима для окружения разработки (`NODE_ENV=development`).
- Реализована возможность использования статического OTP-кода через переменную окружения `OTP_STATIC_CODE`. В этом режиме SMS не отправляется.
- Реализована возможность пропуска отправки SMS (код генерируется и логируется) через переменную окружения `OTP_SKIP_SMS_SEND=true`.
- Обновлена документация проекта (`docs/project.md`) с описанием новых переменных окружения и логики тестового режима OTP.

### Изменено
- Скорректирована логика отправки SMS в `SmsOtpAuthService` для корректной работы тестовых режимов.

### Исправлено
- Исправлена потенциальная ошибка в условии отправки SMS в режиме разработки.

## [2024-07-30] - Восстановлен выбор способа входа и регистрации
### Добавлено
- Современная форма входа по email/паролю (heroUI, loader, ошибки, UX)
- Современная форма регистрации по email/паролю (heroUI, loader, ошибки, UX)
- Кнопки выбора между SMS и email/пароль для входа и регистрации

### Изменено
- Компоненты Login и Register теперь поддерживают оба способа
- Улучшен UX, устранены баги с регистрацией/входом

### Исправлено
- Исправлены ошибки с невозможностью регистрации/входа для новых и существующих пользователей

## [2024-07-29] - Улучшение страницы товара и документации

### Добавлено
- В `tailwind.config.js` добавлен новый фирменный цвет `ugodo` (#BAFF29) и его оттенки.
- На страницу товара в `src/modules/products/components/product-tabs/index.tsx` добавлен новый таб "Отзывы", использующий существующий компонент `ProductReviews`.

### Изменено
- Цвет подчеркивания активного таба на странице товара изменен на `border-ugodo` (`#BAFF29`) в `src/modules/products/components/product-tabs/index.tsx`.
- Таб "Описание" на странице товара переименован в "Описание и характеристики" и дополнен выводом основных характеристик товара (артикул, вес, габариты, материал, страна происхождения) в `src/modules/products/components/product-tabs/index.tsx`.
- Таб "Доставка и возврат" на странице товара переименован в "Доставка, оплата и возврат" и дополнен информацией об оплате и более подробной информацией о доставке и возврате в `src/modules/products/components/product-tabs/index.tsx`.
- Таб "О бренде" на странице товара (`src/modules/products/components/product-tabs/index.tsx`) доработан: добавлена ссылка на страницу бренда, отображение логотипа и описания бренда из метаданных коллекции (если они доступны).
- Галерея изображений товара (`src/modules/products/components/product-gallery/index.tsx`) адаптирована для мобильных устройств:
  - На экранах < 768px миниатюры отображаются горизонтально под основным изображением; основное изображение и миниатюры занимают всю ширину.
  - Реализовано открытие изображений на весь экран в модальном окне (с использованием Headless UI Dialog и Embla Carousel) с навигацией и кнопкой закрытия для мобильных устройств.
- На странице товара (`src/modules/products/templates/index.tsx`) добавлены горизонтальные отступы (`px-4`) для основных контентных блоков на мобильных устройствах.
- Актуализированы задачи в `tasktracker.md` по странице товара.

### Исправлено
- Исправлена ошибка типизации опций для Embla Carousel в `src/modules/products/components/product-gallery/index.tsx`.
- В `ProductGallery` использование `selectedSnap()` вместо `selectedScrollSnap()` для более точного определения активного слайда в `onSelect`.
- Исправлена ошибка импорта `LocalizedClientLink` в `src/modules/products/components/product-tabs/index.tsx` в табе "О бренде".

## [2024-07-28] - Расширение документации и формирование роадмапа
### Добавлено
- В `docs/tasktracker.md` добавлены новые задачи на основе анализа проекта и сайта-примера (goldapple.ru):
  - Улучшение главной страницы
  - Реализация списка желаний (Wishlist)
  - Расширенная система отзывов о товарах
  - Интеграция с платежными системами
  - Настройка системы уведомлений (Email)
  - Улучшение страницы товара (общая задача, детализирована позже)
  - Базовая программа лояльности
  - Улучшение поиска товаров
  - Создание контентных разделов (Блог/Статьи)
- В `docs/project.md` добавлен раздел "План развития и будущие функции (Roadmap High-Level)".

### Изменено
- Актуализирован `docs/tasktracker.md`:
  - Задача "Реализация логики для страницы 'Бестселлеры'" отмечена как завершенная (на текущем этапе).
  - Задача "Создание страниц каталога по аналогии со /store" уточнено описание, статус "Завершена".
  - Подзадача "Формирование роадмапа" в задаче "Настройка и документирование проекта Ugodo" отмечена как выполненная.
- Актуализирован `docs/project.md`:
  - Обновлена информация о существующих страницах каталога (`/brands`, `/new-arrivals`, `/bestsellers`).
  - Уточнена структура модулей фронтенда.
  - Обновлена архитектурная диаграмма Mermaid.
  - Добавлены потенциальные пункты для бэкенда (Уведомления, Программа лояльности, Платежная система - к уточнению).
  - Уточнен технологический стек.

### Исправлено
- (Нет значимых исправлений в этом обновлении, связанных с кодом)

## [2024-03-21] - Диагностика и исправление ошибок после развертывания
### Добавлено
- Зафиксированы ошибки, возникшие при развертывании на сервере.

### Изменено
- Начата работа по устранению ошибок авторизации, обработки параметров маршрутизации и запросов к API.
- Обновлен `tasktracker.md` с текущим статусом исправления ошибок.
- Установлен `data-mode="light"` в корневом `layout.tsx` для консистентности.
- Компоненты `PopularCategories` и `FeaturedBrands` сделаны клиентскими (`"use client";`) для корректной работы `onError`.

### Исправлено
- Устранена ошибка "Unrecognized fields" при запросе категорий путем удаления полей `is_active` и `is_internal`.
- Потенциально исправлена ошибка Hydration Mismatch, связанная с `data-mode`.
- Потенциально исправлена ошибка `Event handlers cannot be passed to Client Component props`.

## [2025-05-19] - Начата упаковка локальных настроек в Docker
### Добавлено
- В `docker-compose.yml` добавлены сервисы Redis и MinIO, проброшены порты, настроены переменные окружения для Medusa.
- Обновлен план по упаковке всех сервисов в Docker для production/dev.

### Изменено
- Обновлен статус задачи в `tasktracker.md` на 'В процессе'.

### Исправлено
- (Нет исправлений на этом этапе)

## [2024-05-20] - Полное удаление Docker-инфраструктуры
### Изменено
- Удалены все Dockerfile, docker-compose.yml и связанные с Docker файлы.
- Удалены все упоминания Docker из документации и tasktracker.

## [2024-12-10] - Создание краткой инструкции по обновлению проекта
### Добавлено
- Создан файл `QUICK_UPDATE_GUIDE.md` с краткой инструкцией по обновлению проекта из GitHub
- Добавлены разделы о Docker и PM2 развертывании
- Включены инструкции по решению проблем с Git конфликтами
- Добавлен чек-лист обновления и экстренное восстановление
- Обновлена основная документация `README.md` со ссылкой на новую инструкцию

### Изменено
- Обновлена секция развертывания в `docs/project.md` с информацией об автоматизированных инструментах
- Добавлена информация о скриптах `deploy.sh`, `monitor.sh`, `fix-git-divergent.sh`
- Расширена документация по мониторингу и поддержке

### Исправлено
- (Нет исправлений в этом обновлении)

## [2025-05-20] - Начало проверки конфигурации MedusaJS
### Добавлено
- Инициализирована задача по проверке конфигурации MedusaJS и подключения к БД в `tasktracker.md`.
- Начата запись в `changelog.md`.

### Изменено
- Нет

### Исправлено
- Нет 

## [2025-05-20] - Анализ конфигурации и подготовка к запуску
### Добавлено
- Проанализирован `medusa-config.ts` и `docker-compose.yml`.
- Определены необходимые переменные окружения для запуска через Docker Compose.
- Подготовлены инструкции для пользователя по созданию файла `.env` (создание файла заблокировано системой).

### Изменено
- Статус задачи в `tasktracker.md` изменен на "Заблокировано".

### Исправлено
- Нет 

## [2025-05-20] - Устранение ошибки модуля и проблемы с .env
### Добавлено
- Зависимость `@medusajs/stock-location` возвращена в `medusa/package.json`.
- Модули `@medusajs/inventory` и `@medusajs/stock-location` добавлены в массив `modules` в `medusa/medusa-config.ts`.

### Изменено
- Обновлен `tasktracker.md`: статус задачи и рекомендации пользователю отражают эти изменения. Предполагается, что явное объявление модулей и наличие зависимости помогут Medusa корректно их инициализировать.

### Исправлено
- Продолжается работа над устранением ошибки `Could not resolve module: Stock_location`.

## [2025-05-20] - Разъяснения по Docker-конфигурации, Traefik и персистентности данных
### Добавлено
- Даны разъяснения пользователю о роли Traefik в `docker-compose.yml` и предложены варианты действий.
- Даны разъяснения о механизмах сохранения данных для PostgreSQL и Minio через именованные тома и влиянии команды `docker-compose down -v`.

### Изменено
- Удален устаревший атрибут `version` из файлов `docker-compose.yml` и `docker-compose.override.yml`.
- Обновлен `tasktracker.md` с учетом предоставленных разъяснений.

### Исправлено
- Нет 

## [2025-05-20] - Удаление Traefik, проблемы с запуском Docker контейнеров
### Добавлено
- Нет

### Изменено
- Сервис `traefik` и связанные с ним `labels` удалены из `docker-compose.yml`.
- Для сервиса `backend` в `docker-compose.yml` явно проброшен порт `9000:9000`.
- Проведены многократные попытки очистки Docker (`docker-compose down -v --remove-orphans`, `docker system prune -a -f --volumes`).
- Сборка образа `backend` через `docker-compose -f docker-compose.yml build backend` проходит успешно.
- Несмотря на успешную сборку, запуск контейнеров через `docker-compose -f docker-compose.yml up -d` не приводит к работающим контейнерам (вывод `docker-compose ps` пуст).
- Обновлен `tasktracker.md`: статус изменен на "В процессе (Проблемы с запуском Docker контейнеров)". Пользователю рекомендовано запустить контейнеры в foreground режиме в своем терминале для получения подробных ошибок.

### Исправлено
- Нет (проблема с запуском контейнеров не решена).

## [2025-05-20] - Диагностика завершения backend контейнера, изменен CMD
### Добавлено
- Нет

### Изменено
- Выявлено, что контейнер `backend` завершается штатно (код 0) сразу после запуска при использовании `docker-compose -f docker-compose.yml up ...`.
- `CMD` в `medusa/Dockerfile` изменен на `sh -c "printenv && yarn start"` для вывода переменных окружения внутри контейнера перед запуском Medusa.
- Обновлен `tasktracker.md`: статус задачи изменен на "В процессе (Диагностика завершения backend контейнера)". Пользователю дана новая рекомендация по запуску команды в его терминале для сбора логов.

### Исправлено
- Нет (проблема с запуском Medusa backend не решена, продолжается диагностика).

## [2025-05-20] - Изменение CMD backend на yarn dev для отладки
### Добавлено
- Нет

### Изменено
- По запросу пользователя `CMD` в `medusa/Dockerfile` изменен с `sh -c "printenv && yarn start"` на `sh -c "printenv && yarn dev"` для целей отладки.
- Обновлен `tasktracker.md`: статус задачи и рекомендации пользователю отражают это изменение.

### Исправлено
- Нет (проблема с запуском Medusa backend не решена, продолжается диагностика с новой командой запуска).

## [2025-05-20] - Удаление зависимости stock-location и ожидание логов
### Добавлено
- Нет

### Изменено
- Обнаружена и удалена зависимость `@medusajs/stock-location` из `medusa/package.json`.
- Проведена очистка `node_modules` и `yarn.lock` в директории `medusa/` и переустановка зависимостей.
- Обновлен `tasktracker.md`: статус задачи и рекомендации пользователю отражают эти изменения. Пользователю рекомендовано выполнить полную очистку Docker, пересборку и запуск для получения актуальных логов.

### Исправлено
- Потенциально устранена ошибка `Could not resolve module: Stock_location` (требуется проверка после получения логов).

## [2025-05-20] - Отключение frontend в Docker, ожидание логов backend
### Добавлено
- Нет

### Изменено
- Сервис `frontend` закомментирован в `docker-compose.yml` для упрощения диагностики проблем с `backend`.
- Обновлен `tasktracker.md` с новой рекомендацией для пользователя по запуску оставшихся сервисов.

### Исправлено
- Продолжается работа над устранением ошибки `Could not resolve module: Stock_location` в сервисе `backend`.

## [2025-05-20] - Диагностика ошибки Stock_location и переменных окружения
### Добавлено
- Нет

### Изменено
- Проанализированы логи Docker, предоставленные пользователем. Ошибка `Could not resolve module: Stock_location` сохраняется.
- Выявлено, что переменная окружения `DATABASE_URL` в контейнере `backend` установлена некорректно (использует `localhost` вместо имени сервиса `postgres`).
- Выявлено, что переменные `REDIS_URL` и `JWT_SECRET` не установлены (пустые).
- Предложено удалить явное объявление модулей `@medusajs/inventory` и `@medusajs/stock-location` из `medusa-config.ts`.
- Настоятельно рекомендовано пользователю создать/обновить файл `.env` с корректными значениями всех переменных окружения.
- Обновлен `tasktracker.md` для отражения этих шагов и рекомендаций.

### Исправлено
- Продолжается работа над устранением ошибки `Could not resolve module: Stock_location` и проблем с конфигурацией окружения.

## [2025-05-20] - Попытка инициализации БД с помощью yarn seed
### Добавлено
- Нет

### Изменено
- В `docs/tasktracker.md` добавлена задача по проверке и использованию `yarn seed` для инициализации базы данных MedusaJS.
- Планируется изменить `medusa/Dockerfile` для выполнения `yarn seed` перед запуском `yarn dev`, если скрипт `seed` будет найден в `medusa/package.json`.

### Исправлено
- Продолжается работа над устранением ошибок отсутствия таблиц в БД (`relation "public.country" does not exist` и т.п.) при запуске сервиса `backend`.

### Удалено
- Нет

## [2025-05-20] - Добавление миграций в процесс запуска backend
### Добавлено
- Нет

### Изменено
- В `docs/tasktracker.md` обновлен шаг по изменению `medusa/Dockerfile`: перед `yarn seed` будет добавлено выполнение миграций `yarn medusa db:migrate`.
- Планируется соответствующее изменение `CMD` в `medusa/Dockerfile`.

### Исправлено
- Улучшен процесс инициализации базы данных: миграции будут применяться перед засеиванием данных.

### Удалено
- Нет

## [2025-05-20] - Удаление сервисов backend и postgres из Docker Compose
### Изменено
- Из файла `docker-compose.yml` удалены сервисы `backend` и `postgres`.
- Из файла `docker-compose.yml` удален том `postgres-data`, так как сервис `postgres` был удален.

### Удалено
- Сервис `backend` (MedusaJS).
- Сервис `postgres` (база данных PostgreSQL).

## [2025-05-20] - Очистка Docker конфигурации и запуск только Redis и MinIO
### Изменено
- Сервис `frontend` закомментирован в `docker-compose.override.yml` для предотвращения его сборки и запуска.
- В `docker-compose.override.yml` порт для сервиса `minio` изменен с `9100:9000` на `9102:9000` для разрешения конфликта портов.
- Успешно запущены только сервисы `redis` и `minio` с использованием `docker-compose up -d` после очистки предыдущих конфигураций.

## [2024-08-01] - Интеграция Minio через S3-провайдер в MedusaJS
### Добавлено
- В `medusa/medusa-config.ts` добавлен и настроен файловый провайдер @medusajs/file-s3 для работы с Minio (bucket: medusa-uploads, endpoint: http://localhost:9000, forcePathStyle: true).

### Изменено
- Удалён провайдер file-local из конфигурации MedusaJS для предотвращения конфликтов.

### Исправлено
- Нет

## [2025-05-20] - Перевод конфигурации Minio на переменные окружения
### Изменено
- В `medusa/medusa-config.ts` параметры S3-провайдера для Minio (`bucket`, `access_key_id`, `secret_access_key`, `endpoint`) заменены на соответствующие переменные окружения.
- В конфигурацию S3-провайдера добавлен новый параметр `file_url` (также через переменную окружения `S3_FILE_URL`) для более гибкого управления URL файлов.

### Добавлено
- Напоминание о необходимости настроить переменные `S3_BUCKET`, `S3_ACCESS_KEY_ID`, `S3_SECRET_ACCESS_KEY`, `S3_ENDPOINT`, `S3_FILE_URL` в файле `.env`.

## [2025-05-21] - Конфигурация Nginx для прямого доступа к Minio и Medusa
### Изменено
- Удалена секция `location /minio/` из конфигурации Nginx для `api.ugodo.ru`.
- Файлы из Minio теперь будут доступны напрямую по URL, указанному в `S3_URL` (например, `http://89.108.110.26:9200/medusa-uploads/`), а не через прокси Nginx.
- Конфигурация Nginx для `api.ugodo.ru` теперь только проксирует запросы к Medusa backend и админ-панели.
- Обновлена документация `tasktracker.md` для отражения изменений в подходе к интеграции с Minio.

### Добавлено
- Предоставлена новая полная конфигурация Nginx.
- Даны инструкции по замене старой конфигурации Nginx и настройке переменных окружения Medusa.
- Описан процесс настройки CORS и политик доступа в Minio.
- Описан процесс смены пароля администратора Minio.

## [2025-05-21] - Успешная интеграция Minio и настройка отображения изображений
### Добавлено
- В конфигурацию Nginx (`/etc/nginx/sites-available/ugodo.conf`) для `api.ugodo.ru` добавлен `location /files/`.
  - Этот location проксирует запросы вида `https://api.ugodo.ru/files/...` на Minio API (`http://127.0.0.1:9200/...`).
  - Использовано правило `rewrite ^/files/(.*)$ /$1 break;` для корректной передачи пути (с именем бакета) в Minio.

### Изменено
- Переменная окружения `S3_URL` в файле `.env` Medusa бэкенда изменена на `https://api.ugodo.ru/files/medusa-uploads`.
- Это изменение, в сочетании с новой конфигурацией Nginx, обеспечило загрузку изображений по HTTPS с того же домена, что и админ-панель Medusa.

### Исправлено
- Устранена проблема с неотображением изображений в админ-панели Medusa (`https://api.ugodo.ru/app/`). Причиной была ошибка "Mixed Content", так как админка (HTTPS) пыталась загрузить изображения из Minio по HTTP.

### Завершено
- Задача по интеграции Minio через S3-провайдер в MedusaJS, включая корректное отображение изображений в админке, успешно завершена.

## [2025-05-21] - Начало работы над скриптом миграции изображений в Minio
### Добавлено
- Начата разработка Node.js скрипта для миграции существующих локальных изображений в Minio.
- Определены основные шаги для скрипта: подключение к БД, выборка старых URL, загрузка в Minio, обновление URL в БД.

### Изменено
- Нет

### Исправлено
- Нет

## [2025-05-21] - Исправление пути к локальным файлам в скрипте миграции
### Добавлено
- Нет

### Изменено
- В скрипте `medusa/migration-scripts/migrate_images_to_minio.js` скорректированы переменные `LOCAL_STATIC_PATH_BASE` и `LOCAL_UPLOADS_PATH_BASE` для правильного указания на директории `medusa/static/` и `medusa/uploads/` соответственно.

### Исправлено
- Устранена ошибка "ENOENT: no such file or directory" при попытке чтения локальных файлов изображений во время миграции.

## [2025-05-21] - Исправление обработки имен файлов с пробелами в скрипте миграции
### Добавлено
- Нет

### Изменено
- В скрипте `medusa/migration-scripts/migrate_images_to_minio.js` добавлено декодирование (`decodeURIComponent`) сегмента URL файла перед формированием пути к локальному файлу. Это позволяет корректно обрабатывать имена файлов, содержащие пробелы или другие URL-закодированные символы.

### Исправлено
- Устранена ошибка "ENOENT: no such file or directory" для файлов, имена которых содержат пробелы (например, `...optimize%20(1)%20(1).jpg`).

## [2025-05-21] - Обсуждение процесса восстановления проекта
### Добавлено
- Обсужден и задокументирован предполагаемый процесс восстановления проекта (MedusaJS, PostgreSQL, Minio, Next.js, Nginx) после переустановки операционной системы.
- Подчеркнута важность регулярного резервного копирования базы данных PostgreSQL, данных Minio и использования системы контроля версий Git для кода и конфигураций.

### Изменено
- Нет

### Исправлено
- Нет

## [2025-05-21] - КРИТИЧЕСКАЯ ОШИБКА: Сервер не загружается (No init found)
### Добавлено
- Нет

### Изменено
- Нет

### Исправлено
- Диагностирована критическая проблема с загрузкой операционной системы сервера. Сервер не может найти процесс `init` и падает в оболочку `initramfs`.
- Вся дальнейшая работа над проектом Ugodo на этом сервере заблокирована до восстановления работоспособности ОС.
- Предполагаемые причины: повреждение файловой системы, неудачное обновление, проблемы с жестким диском, повреждение загрузчика.
- Описаны общие шаги по возможному восстановлению (проверка файловой системы, проверка оборудования, восстановление загрузчика, восстановление из бэкапа ОС, переустановка ОС).

## [2025-05-22] - Начало внедрения Tiered Pricing
### Добавлено
- Начата работа над функционалом оптовых скидок (tiered pricing).
- Проанализирована структура API Medusa для поддержки tiered pricing.

### Изменено
- Нет изменений.

### Исправлено
- Нет исправлений.

## [2025-05-23] - Уточнение реализации Tiered Pricing
### Добавлено
- Нет.

### Изменено
- Уточнено, что расчет tiered pricing будет происходить на стороне MedusaJS (бэкенд), особенно при работе с корзиной. 
- Фронтенд будет отображать цены, предоставляемые API Medusa. 
- Функция `getProductPrice` не будет самостоятельно рассчитывать tiered price, а будет отображать базовую цену варианта.

### Исправлено
- Нет.

## [2025-05-30] - Документирование модуля OTP авторизации
### Добавлено
- Создан файл OpenAPI спецификации `docs/otp_api.yaml` для эндпоинтов OTP авторизации.
- В `docs/project.md` добавлено подробное описание модуля SMS OTP авторизации, включая архитектуру, используемые компоненты и ссылку на `docs/otp_api.yaml`.

### Изменено
- Актуализирована информация об OTP аутентификации в `docs/project.md`.

## [2025-05-30] - Исправление путей API для OTP авторизации
### Изменено
- Исправлены пути API для OTP авторизации в соответствии с документацией плагина `@perseidesjs/auth-otp`.
- Обновлены JSDoc аннотации для Swagger, заменены `/store/auth/customer/otp/...` на `/auth/customer/otp/...`.
- Обновлены названия параметров с `phone` и `code` на `identifier` и `otp` соответственно.

### Исправлено
- Устранена ошибка 404 при вызове API OTP из Swagger UI.

## [2025-05-30] - Интеграция OTP API в Swagger документацию
### Добавлено
- Созданы JSDoc аннотации для OTP API эндпоинтов в Swagger.
- Добавлены маршруты `/store/auth/customer/otp/pre-register`, `/store/auth/customer/otp/verify`, `/store/auth/customer/otp/register` и `/store/auth/customer/otp/authenticate` в Swagger UI.
- Настроена поддержка CORS для Swagger UI.

### Изменено
- Улучшены CORS заголовки для `/doc` и `/doc/storefront` для предотвращения ошибок при запросах с фронтенда.
- Добавлен тег "Customer OTP Auth" в документацию Swagger.

## [2025-05-30] - Подключение полной документации Storefront API
### Добавлено
- Подключена полная спецификация Storefront API из файла `openapi (1).yaml` в Swagger UI.
- Добавлена документация по `/store/customers` для проверки зарегистрированных пользователей.

### Изменено
- Разкомментирован код загрузки внешней спецификации в `medusa/src/api/doc/storefront/route.ts`.

## [2025-05-31] - Новый эталонный flow SMS-авторизации
### Изменено
- Реализован пошаговый flow: после register всегда проверяется наличие Customer, если не найден — запрашивается email/имя/фамилия, затем создаётся Customer и выполняется authenticate
- Улучшен UX: email/имя/фамилия запрашиваются только для новых пользователей
- Исправлены ошибки, связанные с отсутствием email при создании Customer

## [2025-05-31] - Phone-only регистрация с автогенерацией email
### Изменено
- Теперь регистрация по SMS возможна без email: если email не указан, он генерируется автоматически на основе номера телефона (например, phone+79991234567@ugodo.local)
- Пользователь может добавить email позже для восстановления доступа

## [2025-05-31] - Новый UX и flow SMS-авторизации
### Изменено
- После register всегда создаётся Customer (POST /store/customers), email генерируется автоматически, если не введён
- После создания Customer делается GET /store/customers/me
- Современный дизайн формы (heroUI + Tailwind), пошаговые подсказки, loader'ы, дружелюбные ошибки
- Улучшена обработка ошибок (401/409) и UX для пользователя

## [2025-05-31] - Полный переход на SMS-only регистрацию/авторизацию
### Изменено
- Удалены все формы и компоненты email/пароль (вход, регистрация, смена email/пароля)
- Все переходы и кнопки ведут только на SMS-авторизацию
- Перепроверена передача publishable key во всех запросах

## [2025-06-01] - Аудит и исправление генерации OTP и CORS
### Изменено
- Проведён аудит и гарантирована генерация и логирование OTP для любого номера (и для входа, и для регистрации) в сервисе `SmsOtpAuthService`.
- Исправлена и перепроверена конфигурация CORS для всех публичных auth-эндпоинтов (`/auth/customer/otp/*`).
- Проведён code review изменений, обновлена документация.

### Исправлено
- Устранены проблемы с отсутствием OTP для входа и ошибками CORS при авторизации.

## [2025-06-01] - Исправлен flow SMS-авторизации: автоматический вызов /verify для существующих пользователей
### Исправлено
- В компоненте `LoginSMS` исправлен flow: если /pre-register возвращает ошибку 'Actor already exists' (или 409/400), фронтенд автоматически вызывает /verify для генерации и отправки OTP существующему пользователю.
- Теперь OTP всегда отправляется и для новых, и для существующих пользователей, flow полностью соответствует best practice PerseidesJS.

## [2024-06-11] - Реализация фронтенд-модуля SMS OTP авторизации (этап 1)
### Добавлено
- Созданы server actions для pre-register, register, authenticate (actions.ts)
- Реализован компонент формы авторизации с двумя шагами (index.tsx)
- Добавлены схемы валидации через zod (validation.ts)
- Обновлена документация (changelog, tasktracker, project.md)

### Изменено
- Нет

### Исправлено
- Нет

## [2024-06-11] - Исправлена логика и дизайн SMS OTP авторизации
### Исправлено
- Теперь при ошибке 'Actor already exists' (даже если статус 200) форма автоматически переходит на логин и отправляет OTP.
### Изменено
- Улучшен дизайн формы SMS OTP авторизации: Card, заголовки, кнопки, loader, UX.

## [2024-08-01] - Реализована объединённая страница для SMS регистрации и авторизации
### Добавлено
- На странице /account/sms-auth реализованы оба сценария (логин и регистрация по SMS) с независимой логикой и переключением через табы/кнопки
- Каждый сценарий реализован как отдельный подкомпонент с собственной логикой, обработкой ошибок и UX-переходами

### Изменено
- Старый универсальный flow заменён на два независимых сценария с явным разделением логики
- Улучшен UX: ошибки и переходы реализованы согласно best practice PerseidesJS

### Исправлено
- Исправлен редирект после авторизации и регистрации (SMS и email) — теперь используется router.replace('/account') вместо window.location.href/router.push для корректного SSR и отображения личного кабинета

## [2024-06-13] - Очистка и миграция product-media
### Добавлено
- Вручную создана и применена миграция для product-media

### Изменено
- Очищен проект от старых модулей video/product-video
- Исправлен medusa-config.ts: теперь используется только product-media

### Исправлено
- Устранены ошибки запуска миграций, база данных приведена к актуальному состоянию

## [2024-06-13] - Архитектура поддержки видео в медиа товаров
### Добавлено
- Описан подход: хранение видео и изображений в одной таблице product_media с типом (image/video)
- Для хранения файлов используется File Module (S3/MinIO), в product_media хранится fileId или url
- Для связи с продуктом используется module link между Product и ProductMedia
- CRUD-операции с медиа реализуются через сервис product-media, а не через отдельные кастомные API
- Загрузка файлов — только через File Module, создание записи — через сервис product-media
- В админке видео и изображения отображаются в одном списке, с превью и возможностью просмотра
- В ответах на запросы к продукту возвращаются все связанные медиа

### Изменено
- Уточнён план внедрения: module link, CRUD-сервис, фронт и UI

### Исправлено
- Нет