/**
 * @file: tasktracker.md
 * @description: Отслеживание статуса выполнения задач по проекту Ugodo.
 * @dependencies: N/A
 * @created: 2025-05-22
 */

## Задача: Настройка и документирование проекта Ugodo
- **Статус**: В процессе
- **Описание**: Изучение проекта, настройка базовой документации (changelog, tasktracker, project.md), анализ технологий и формирование первоначального роадмапа.
- **Шаги выполнения**:
  - [x] Создание файла `/docs/changelog.md`
  - [x] Создание файла `/docs/tasktracker.md`
  - [x] Создание файла `/docs/project.md`
  - [x] Изучение документации по heroUI и MedusaJS
  - [x] Анализ структуры проекта и ключевых файлов (`package.json`, `src/`, `medusa/`)
  - [x] Первичное заполнение `/docs/project.md` (Архитектура, Технологический стек)
  - [x] Формирование роадмапа в `/docs/tasktracker.md` (добавлены новые задачи на основе анализа)
  - [ ] Добавление стандартных заголовков с метаданными к файлам
  - [ ] Обновление навигации для новых страниц (если требуется)
  - [x] Реализация логики для страницы "Бестселлеры"
- **Зависимости**: Нет

## Задача: Улучшение мобильного интерфейса
- **Статус**: Завершена
- **Описание**: Убрать отступы слева и справа у блока `.content-container` на мобильных устройствах. Исправить ссылки в нижнем мобильном меню.
- **Шаги выполнения**:
  - [x] Модификация стилей для `.content-container` в `src/styles/globals.css`
  - [x] Исправление ссылки "Каталог" в `MobileBottomNav` (`src/modules/mobile/components/index.tsx`) с `/categories` на `/store`.
- **Зависимости**: Нет

## Задача: Создание страниц каталога по аналогии со /store
- **Статус**: Завершена
- **Описание**: Создать страницы `/brands`, `/new-arrivals`, `/bestsellers` с функциональностью, аналогичной `/store`, включая фильтрацию и пагинацию. Логика для "Бестселлеров" реализована через фильтрацию по тегу.
- **Шаги выполнения**:
  - [x] Создание страницы `/brands` (`src/app/[countryCode]/(main)/brands/page.tsx`) для отображения списка коллекций (брендов).
  - [x] Адаптация страницы отображения коллекции (`src/app/[countryCode]/(main)/collections/[handle]/page.tsx`) для использования фильтров.
  - [x] Обновление `CollectionTemplate` (`src/modules/collections/templates/index.tsx`) для приема `searchParams`, `filterData` и использования `ProductFilters`.
  - [x] Создание компонента `CollectionProductsDisplay` (`src/modules/collections/components/collection-products-display/index.tsx`) для отображения продуктов коллекции с фильтрацией и пагинацией.
  - [x] Создание страницы `/new-arrivals` (`src/app/[countryCode]/(main)/new-arrivals/page.tsx`) с сортировкой по умолчанию по дате создания.
  - [x] Создание страницы `/bestsellers` (`src/app/[countryCode]/(main)/bestsellers/page.tsx`) (логика реализована через фильтрацию по тегу 'bestseller').
- **Зависимости**: Задача "Улучшение мобильного интерфейса" (исправление навигации)

## Задача: Реализация логики для страницы "Бестселлеры"
- **Статус**: Завершена
- **Описание**: Доработана страница `/bestsellers`. Реализована фильтрация по тегу "bestseller" на фронтенде. Для более сложной логики (например, на основе реальных продаж) может потребоваться доработка бэкенда, что может быть выделено в отдельную задачу.
- **Шаги выполнения**:
  - [x] Определить критерии "бестселлера" (выбран вариант с фильтрацией по тегу 'bestseller').
  - [x] Исследовать возможности MedusaJS API (стандартные опции сортировки не включают "популярность" или "продажи").
  - [x] Обновить функцию `fetchBestsellersProductData` на странице `/bestsellers/page.tsx` для фильтрации по тегу 'bestseller' по умолчанию.
- **Зависимости**: Задача "Создание страниц каталога по аналогии со /store"

## Задача: Актуализация навигации
- **Статус**: Завершена
- **Описание**: Убедиться, что все созданные страницы (`/brands`, `/new-arrivals`, `/bestsellers`) доступны через основную навигацию сайта. Десктопная навигация (`src/modules/layout/templates/nav/index.tsx`) уже содержала необходимые ссылки. Мобильная навигация (`MobileNav` в `src/modules/mobile/components/index.tsx`) обновлена.
- **Шаги выполнения**:
  - [x] Проанализировать компоненты навигации (`Nav`, `MobileNav`, `MobileBottomNav`).
  - [x] Добавить ссылки на новые страницы в `MobileNav`.
  - [x] Протестировать корректность работы ссылок (предполагается ручное тестирование).
- **Зависимости**: Задача "Создание страниц каталога по аналогии со /store"

## Задача: Документирование существующего кода
- **Статус**: В процессе
- **Описание**: Добавить стандартные заголовки с метаданными (согласно `required_instructions`) ко всем существующим файлам `.tsx`, `.ts`, `.jsx`, `.js` в директориях `src/` и `medusa/src/`.
- **Шаги выполнения**:
  - [ ] Разработать скрипт или план для систематического добавления заголовков.
  - [x] Поэтапно добавить заголовки к файлам страниц: `brands/page.tsx`, `new-arrivals/page.tsx`, `bestsellers/page.tsx`.
  - [x] Поэтапно добавить заголовки к файлам компонентов: `mobile/components/index.tsx`, `collections/templates/index.tsx`, `collections/components/collection-products-display/index.tsx`.
  - [x] Поэтапно добавить заголовок к файлу страницы коллекции: `collections/[handle]/page.tsx`.
  - [x] Исправлена типизация в `listProductTypes` (`src/lib/data/product-filters.ts`) для соответствия API.
  - [ ] Продолжить добавление заголовков к остальным файлам проекта.
- **Зависимости**: Нет

## Задача: Уточнение использования UI-библиотеки
- **Статус**: Завершена
- **Описание**: В `package.json` указана зависимость `@medusajs/ui`. Изначально предполагалось использование HeroUI, но анализ импортов показал активное использование `@medusajs/ui` и отсутствие импортов `@heroui/react`. Документация (`/docs/project.md`) обновлена.
- **Шаги выполнения**:
  - [x] Провести поиск по коду на предмет импортов из `@heroui/react` и `@medusajs/ui`.
  - [x] Определить основную используемую UI-библиотеку (@medusajs/ui).
  - [x] Обновить раздел "Фронтенд" и "Технологический стек" в `/docs/project.md`.
- **Зависимости**: Нет

## Задача: Улучшение главной страницы
- **Статус**: В процессе
- **Описание**: Сделать главную страницу более информативной и привлекательной, добавив динамические блоки согласно утвержденной структуре.
- **Шаги выполнения**:
  - [x] Проанализировать главные страницы конкурентов (включая goldapple.ru) и успешных e-commerce проектов.
  - [x] Разработать дизайн/макет для новых блоков (баннеры, карусели акций, популярные категории, блок новинок, блок рекомендуемых товаров/брендов) и описать структуру в `docs/project.md`.
  - [x] **Блок 1: Hero Banner**
    - [x] Заменить компонент `HeroBanner` (`src/modules/layout/components/hero-banner/index.tsx`) на `Hero` (`src/modules/home/components/hero/index.tsx`).
    - [x] Удалить старый компонент `HeroBanner`.
  - [x] **Блок 2: Популярные категории**
    - [x] Создать компонент `PopularCategories` (`src/modules/home/components/popular-categories/index.tsx`) для отображения популярных категорий.
    - [x] Реализовать получение данных о категориях (верхнеуровневые, активные, не внутренние) на главной странице.
    - [x] Интегрировать компонент `PopularCategories` на главную страницу.
  - [ ] **Блок 3: Новинки**
    - [x] Создать компонент для отображения карусели/сетки новых товаров (используется существующий `ProductSection`).
    - [x] Реализовать получение данных о новинках (последние добавленные товары) (уже было на главной странице).
    - [x] Интегрировать компонент на главную страницу (уже было интегрировано).
  - [ ] **Блок 4: Хиты продаж / Рекомендованные товары**
    - [x] Создать компонент для отображения хитов продаж или рекомендованных товаров (используется существующий `ProductSection`).
    - [x] Определить логику получения данных (по тегу "bestseller" с получением ID тега через `getTagByValue`).
    - [x] Интегрировать компонент на главную страницу (обновлена логика получения данных для существующего блока).
    - [ ] *Примечание: Возможна проблема с типизацией `tags` в `StoreProductParams` от `@medusajs/types`. Использовано `as any` как временное решение. Требует дополнительного изучения.*
  - [ ] **Блок 5: Специальные акции / Промо-блоки**
    - [x] Создать компонент для отображения специальных предложений или промо-баннеров (используется существующий `PromotionsSlider`).
    - [x] Интегрировать компонент на главную страницу (уже был интегрирован, использует статические данные).
  - [ ] **Блок 6: Бренды**
    - [x] Создать компонент `FeaturedBrands` (`src/modules/home/components/featured-brands/index.tsx`) для отображения логотипов или карточек ключевых брендов.
    - [x] Реализовать получение данных о коллекциях (брендах) на главной странице.
    - [x] Интегрировать компонент `FeaturedBrands` на главную страницу.
  - [ ] **Блок 7: Контентный блок (О нас / Преимущества)**
    - [x] Удалить компонент `InfoBlock` (`src/modules/home/components/info-block/index.tsx`) с главной страницы.
    - [x] Удалить файл компонента `InfoBlock`.
  - [ ] **Блок 8: Подписка на рассылку**
    - [ ] Создать или интегрировать существующий компонент подписки на email-рассылку.
    - [ ] Интегрировать компонент на главную страницу.
- **Зависимости**: Возможно, "Интеграция с системой управления контентом (CMS)" для баннеров и контентных блоков.

## Задача: Реализация списка желаний (Wishlist)
- **Статус**: Не начата
- **Описание**: Предоставить пользователям возможность добавлять товары в список желаний для последующего просмотра или покупки.
- **Шаги выполнения**:
  - [ ] Исследовать существующие плагины MedusaJS для списка желаний или определить способ кастомной реализации.
  - [ ] Разработать модель данных для списка желаний (если кастомная реализация).
  - [ ] Создать API эндпоинты для добавления/удаления/получения товаров из списка желаний.
  - [ ] Интегрировать кнопки "Добавить в избранное" на карточках товаров и на странице товара.
  - [ ] Создать страницу "Список желаний" в личном кабинете пользователя.
  - [ ] Обеспечить сохранение списка желаний для зарегистрированных пользователей.
- **Зависимости**: Функционал личного кабинета пользователя.

## Задача: Расширенная система отзывов о товарах
- **Статус**: Не начата
- **Описание**: Улучшить текущую систему отзывов, добавив рейтинги, возможность прикреплять фото, сортировку и фильтрацию отзывов.
- **Шаги выполнения**:
  - [ ] Оценить возможности существующих плагинов (`@appateam/medusa-plugin-product-reviews`, `medusa-plugin-reviews`) на предмет поддержки расширенного функционала.
  - [ ] Если плагины не подходят, спланировать доработку или кастомную реализацию.
  - [ ] Добавить поле для числового рейтинга (1-5 звезд) к отзывам.
  - [ ] Реализовать загрузку изображений к отзывам.
  - [ ] Добавить возможность модерации отзывов в админ-панели Medusa.
  - [ ] Отображать средний рейтинг на карточке товара и странице товара.
  - [ ] Реализовать сортировку и фильтрацию отзывов на странице товара.
- **Зависимости**: Базовая система отзывов.

## Задача: Интеграция с платежными системами
- **Статус**: Не начата
- **Описание**: Настроить и интегрировать одну или несколько платежных систем для приема онлайн-оплат.
- **Шаги выполнения**:
  - [ ] Выбрать целевые платежные системы (например, Stripe, YooKassa, локальные эквайринги).
  - [ ] Изучить и установить соответствующие плагины MedusaJS для выбранных систем.
  - [ ] Настроить плагины с тестовыми и боевыми ключами.
  - [ ] Протестировать процесс оплаты на фронтенде.
  - [ ] Обеспечить корректное обновление статусов заказов после оплаты.
- **Зависимости**: Нет.

## Задача: Настройка системы уведомлений (Email)
- **Статус**: Не начата
- **Описание**: Настроить отправку email-уведомлений пользователям и администраторам о ключевых событиях (регистрация, заказ создан, заказ отправлен и т.д.).
- **Шаги выполнения**:
  - [ ] Выбрать сервис для отправки email (например, SendGrid, Mailgun, или локальный SMTP).
  - [ ] Установить и настроить соответствующий плагин уведомлений в MedusaJS (например, `medusa-plugin-sendgrid`).
  - [ ] Кастомизировать шаблоны email-уведомлений.
  - [ ] Протестировать отправку уведомлений для всех ключевых событий.
- **Зависимости**: Нет.

## Задача: Улучшение страницы товара
- **Статус**: Не начата
- **Описание**: Сделать страницу товара более информативной и удобной для пользователя. Часть улучшений вынесена в отдельную детализированную задачу "Приведение страницы товара в надлежащий вид". Эта задача фокусируется на оставшихся аспектах.
- **Шаги выполнения**:
  - [ ] Проанализировать страницы товаров у конкурентов (общий анализ).
  - [ ] Улучшить галерею изображений товара (зум основной картинки, возможность добавления видео к товару).
  - [ ] Реализовать блок "С этим товаром покупают" или "Похожие товары".
  - [ ] Отображать информацию о наличии вариантов товара и их доступности (если еще не полностью реализовано).
  - [ ] Улучшить отображение информации о скидках и программе лояльности на странице товара (если применимо).
- **Зависимости**: "Расширенная система отзывов о товарах", "Базовая программа лояльности", "Приведение страницы товара в надлежащий вид".

## Задача: Приведение страницы товара в надлежащий вид
- **Статус**: В процессе
- **Описание**: Улучшить внешний вид и функциональность страницы с подробной информацией о товаре, включая отображение характеристик, стилизацию табов, адаптацию для мобильных устройств и исправление позиционирования элементов.
- **Шаги выполнения**:
  - [x] Вывести характеристики товара из метаданных MedusaJS на страницу товара (функционал присутствует в `src/modules/products/components/product-info/index.tsx`, возможно, потребуется стилизация и проверка полноты данных).
  - [x] **Общие/Десктоп:** Заменить цвет подчеркивания у табов на странице товара на `#BAFF29`.
  - [x] **Общие/Десктоп:** Проанализировать и расширить содержимое табов.
    - [x] Создать/обновить таб "Описание и характеристики" (объединить описание, артикул, добавить вес, размеры, материал, страна происхождения из `product` объекта).
    - [x] Создать/обновить таб "Отзывы" (интегрировать существующий компонент `ProductReviews`).
    - [x] Создать/обновить таб "Доставка и возврат" (расширить информацией об оплате, возможно, переименовать в "Доставка, оплата и возврат").
    - [x] Проверить и при необходимости доработать таб "О бренде" (добавлена ссылка, логотип и описание из метаданных).
  - [ ] **Мобильная версия:** Галерея картинок:
    - [x] Адаптировать макет: основное изображение по центру и на всю ширину, миниатюры горизонтально снизу (для экранов < 768px).
    - [x] Реализовать открытие изображений на весь экран (в модальном окне с Embla каруселью и навигацией).
  - [x] **Мобильная версия:** Добавить отступы слева и справа (`px-4`) для всего контента страницы товара.
- **Зависимости**: Существующая страница товара, компонент табов, данные о товаре из MedusaJS, глобальные стили `content-container`.

## Задача: Базовая программа лояльности
- **Статус**: Не начата
- **Описание**: Реализовать простую программу лояльности (например, накопительные скидки или бонусные баллы).
- **Шаги выполнения**:
  - [ ] Исследовать возможности MedusaJS и существующих плагинов для программ лояльности.
  - [ ] Определить механику программы (например, начисление баллов за покупки, скидка от суммы заказов).
  - [ ] Если плагинов нет, спланировать кастомную разработку (модели, сервисы, API).
  - [ ] Интегрировать отображение информации о программе лояльности в личном кабинете и на странице оформления заказа.
- **Зависимости**: Личный кабинет пользователя.

## Задача: Улучшение поиска товаров
- **Статус**: Не начата
- **Описание**: Повысить удобство и эффективность поиска по сайту.
- **Шаги выполнения**:
  - [ ] Реализовать живой поиск с подсказками (autocomplete) при вводе в поисковую строку.
  - [ ] Улучшить релевантность результатов поиска (возможно, через конфигурацию MeiliSearch).
  - [ ] Добавить возможность фильтрации и сортировки на странице результатов поиска.
  - [ ] Рассмотреть обработку опечаток и синонимов.
- **Зависимости**: Интеграция с MeiliSearch.

## Задача: Создание контентных разделов (Блог/Статьи)
- **Статус**: Не начата
- **Описание**: Добавить на сайт раздел с блогом или статьями для улучшения SEO и вовлечения пользователей.
- **Шаги выполнения**:
  - [ ] Выбрать способ управления контентом (простой модуль в Medusa, headless CMS типа Strapi/Contentful, или markdown-файлы в Next.js проекте).
  - [ ] Разработать структуру данных для статей (заголовок, контент, автор, дата, категории, теги).
  - [ ] Создать страницы для списка статей и для отдельной статьи.
  - [ ] Реализовать базовый WYSIWYG-редактор или поддержку Markdown для создания контента.
- **Зависимости**: Нет.

## Задача: Исправление ошибки 422 при создании клиента (POST /store/customers)
- **Статус**: Завершена
- **Описание**: Устранена ошибка 422 "Unprocessable Entity" при отправке запроса на создание клиента после SMS регистрации.
- **Шаги выполнения**:
  - [x] Проанализирован код компонента `LoginSMS` (`src/modules/account/components/login-sms/index.tsx`).
  - [x] Выявлена потенциальная причина ошибки: отправка пустых полей 'Имя' и 'Фамилия' в запросе `POST /store/customers`.
  - [x] Добавлен атрибут `required` к полям ввода 'Имя' и 'Фамилия' в форме завершения регистрации по SMS.
  - [x] Обновлена документация (`changelog.md`, `tasktracker.md`).
- **Зависимости**: Отсутствуют.

## Задача: Упаковка проекта Ugodo в Docker (production)
- **Статус**: В процессе
- **Описание**: Подготовить production-окружение на базе Docker Compose для сервисов MedusaJS (backend), Next.js (frontend), PostgreSQL, Redis, MinIO. Все сервисы должны запускаться одной командой, использовать production-конфигурации и переменные окружения. Dev-режим и hot-reload не реализуются.
- **Шаги выполнения**:
  - [x] Составить план упаковки и архитектуру docker-инфраструктуры
  - [x] Зафиксировать задачу и обновить changelog
  - [x] Создать docker-compose.yml с сервисами: medusa, nextjs, postgres, redis, minio
  - [x] Создать Dockerfile для medusa (production)
  - [x] Создать Dockerfile для nextjs (production)
  - [x] Описать volumes, сети, переменные окружения
  - [x] Исправить проброс env для Next.js на этапе build
  - [ ] Протестировать запуск всех сервисов
  - [ ] Провести code review и актуализировать документацию
- **Зависимости**: docker, nextjs, medusajs, postgresql, redis, minio

## Задача: Оптимизация Docker-конфигурации
- **Статус**: Завершена
- **Описание**: Оптимизация Docker-конфигурации для production и development окружений
- **Шаги выполнения**:
  - [x] Создание multi-stage Dockerfile для frontend
  - [x] Создание multi-stage Dockerfile для backend
  - [x] Оптимизация docker-compose.yml
  - [x] Настройка Traefik как reverse proxy
  - [x] Настройка ресурсных лимитов
  - [x] Оптимизация кэширования
  - [x] Настройка безопасности
  - [x] Создание docker-compose.override.yml
  - [x] Добавление Docker-скриптов
  - [x] Обновление документации
- **Зависимости**: 
  - Medusa.js backend
  - Next.js frontend
  - PostgreSQL
  - Redis
  - MinIO
- **Результаты**:
  - Уменьшен размер образов
  - Улучшена безопасность
  - Оптимизирована производительность
  - Настроено development окружение
  - Добавлены удобные скрипты управления

## Задача: Проверка конфигурации MedusaJS и подключения к БД
- **Статус**: Завершена (Redis и MinIO запущены, остальное удалено из Docker)
- **Описание**: По запросу пользователя конфигурация Docker была упрощена. Удалены сервисы `backend` и `postgres`. Сервис `frontend` закомментирован. Устранены конфликты портов. Запущены только `redis` и `minio`.
- **Шаги выполнения**:
  - [x] Получить актуальную дату
  - [x] Инициализировать/обновить файлы документации (tasktracker.md, changelog.md)
  - [x] Найти документацию MedusaJS по подключению к БД и запуску
  - [x] Проверить файл `medusa-config.ts` на корректность настроек БД
  - [x] Найти `docker-compose.yml` и проанализировать конфигурацию сервисов
  - [x] Определить переменные окружения для `.env`
  - [x] Удалить модуль `@medusajs/stock-location` из `medusa-config.ts`
  - [x] Удалить зависимость `@medusajs/stock-location` из `medusa/package.json`
  - [x] Попытка запустить `docker-compose up --build -d`
  - [x] Анализ логов `backend`, выявление проблем с переменными окружения и модулем `Stock_location`.
  - [x] Возврат `@medusajs/stock-location` в `package.json` и `medusa-config.ts`
  - [x] Закомментирован сервис `frontend` в `docker-compose.yml` для упрощения.
  - [x] Удалены `@medusajs/inventory` и `@medusajs/stock-location` из `medusa-config.ts`.
  - [x] Обновлен `docker-compose.yml` для явного указания `env_file: ./medusa/.env` для сервиса `backend` и переопределения `DATABASE_URL` и `REDIS_URL` для Docker.
  - [x] Анализ логов после изменений `docker-compose.yml` - ошибки `relation "public.country" does not exist` и другие.
  - [x] Проверить наличие скрипта `seed` в `medusa/package.json`.
  - [x] Изменен `CMD` в `medusa/Dockerfile` на `sh -c "printenv && yarn medusa db:migrate && yarn seed && yarn dev"`.
  - [x] Удалены сервисы `backend` и `postgres` из `docker-compose.yml`.
  - [x] Удалены сервисы `backend` и `postgres` из `docker-compose.override.yml`.
  - [x] Закомментирован сервис `frontend` в `docker-compose.override.yml`.
  - [x] Изменен порт для `minio` в `docker-compose.override.yml` для устранения конфликта.
  - [x] Успешно запущены сервисы `redis` и `minio`.
  - [ ] Проверить корректность всех переменных в `medusa/.env` и корневом `.env` (если используется для `postgres` и `redis`).
- **Зависимости**: Корректные переменные окружения в `.env` файлах.

## Задача: Интеграция Minio через S3-провайдер в MedusaJS
- **Статус**: Завершена
- **Описание**: Настроить файловый провайдер MedusaJS для работы с Minio через модуль @medusajs/file-s3. Обеспечить загрузку и хранение файлов в Minio. Устранена проблема с отображением изображений в админке Medusa (`https://api.ugodo.ru/app/`) путем проксирования доступа к файлам Minio через Nginx (HTTPS, тот же домен), что решило проблемы смешанного содержимого.
- **Шаги выполнения**:
  - [x] Изучить документацию MedusaJS по настройке S3-провайдера и особенностям Minio (forcePathStyle, endpoint, credentials).
  - [x] Проверить наличие и версию пакета @medusajs/file-s3.
  - [x] Зафиксировать начало задачи в changelog.md и tasktracker.md.
  - [x] Добавить и настроить провайдер @medusajs/file-s3 в `medusa-config.ts`.
  - [x] Вынести конфигурационные параметры Minio (bucket, region, access_key_id, secret_access_key, endpoint, file_url) в переменные окружения (`.env`).
  - [x] Удалить конфигурацию `file-local` из `medusa-config.ts`.
  - [x] Убедиться, что Minio запущен, доступен и создан бакет `medusa-uploads` с публичным доступом.
  - [x] Проверить загрузку файлов в Minio через админку Medusa (успешно).
  - [x] Проверить прямую ссылку на загруженный файл в Minio (успешно).
  - [x] Диагностировать причину неотображения изображений в админке Medusa (определено как mixed content).
  - [x] Настроить Nginx для проксирования запросов к файлам Minio через `https://api.ugodo.ru/files/` с правилом rewrite.
  - [x] Обновить переменную `S3_URL` в `.env` Medusa на `https://api.ugodo.ru/files/medusa-uploads`.
  - [x] Проверить отображение изображений в админке Medusa (успешно).
  - [x] Провести тестирование загрузки, отображения и удаления файлов.
  - [x] Обновить документацию `project.md` описанием новой конфигурации хранения файлов.
  - [x] Зафиксировать завершение задачи в changelog.md и tasktracker.md.
- **Зависимости**: Minio должен быть запущен и доступен. Nginx должен быть настроен и работать.

## Задача: Настройка Next.js для отображения изображений с Minio (через прокси)
- **Статус**: Не начата
- **Описание**: Устранить ошибку `Invalid src prop ... hostname "api.ugodo.ru" is not configured under images in your next.config.js` на фронтенде. Для этого необходимо добавить `api.ugodo.ru` в список разрешенных хостов для изображений в конфигурационном файле Next.js (`next.config.js`).
- **Шаги выполнения**:
  - [ ] Открыть файл `next.config.js` в корневом каталоге фронтенд-приложения.
  - [ ] Добавить или обновить секцию `images.remotePatterns`, включив в нее объект для `api.ugodo.ru` с протоколом `https` и путем `pathname: '/files/medusa-uploads/**'`.
  - [ ] Перезапустить Next.js приложение (dev сервер или production сборку).
  - [ ] Проверить отображение изображений на фронтенде.
  - [ ] Обновить документацию `changelog.md` и `tasktracker.md` по завершении.
- **Зависимости**: Задача "Интеграция Minio через S3-провайдер в MedusaJS" должна быть завершена.

## Задача: Миграция существующих локальных изображений в Minio
- **Статус**: В процессе
- **Описание**: Разработать и выполнить скрипт для переноса изображений, ранее хранившихся локально и доступных по URL вида `http://localhost:9000/static/...` или `http://localhost:9000/uploads/...`, в Minio. Скрипт должен обновить пути к файлам в базе данных Medusa.
- **Шаги выполнения**:
  - [x] Определить точное местоположение старых файлов на сервере (предположительно `medusa/static/`).
  - [x] Обеспечить доступ к базе данных PostgreSQL проекта Medusa (пользователь `medusa` может подключаться локально с паролем).
  - [x] Разработать Node.js скрипт, который:
    - [x] Создать директорию `scripts` в корне проекта и файл `migrate-images-to-minio.js` (путь к скрипту `medusa/migration-scripts/migrate_images_to_minio.js`)
    - [x] Добавить необходимые зависимости (`pg`, `@aws-sdk/client-s3`, `dotenv`) в `package.json` (в `medusa/migration-scripts/package.json`) и установить их.
    - [x] Реализовать чтение конфигурации для PostgreSQL и Minio (из `.env` Medusa).
    - [x] Реализовать подключение к PostgreSQL.
    - [x] Определить таблицу и поля в БД Medusa, хранящие URL изображений (в скрипте используется "image" и "url", требует проверки пользователем).
    - [x] Реализовать выборку записей о файлах со старыми локальными путями.
    - [x] Реализовать подключение к Minio.
    - [x] Для каждого файла: 
        - [x] Извлечь имя файла и сформировать локальный путь.
        - [x] Прочитать файл из локальной файловой системы. (Исправлен путь к файлам, добавлено декодирование имен файлов)
        - [ ] Загрузить файл в Minio с новым ключом (например, `products/filename.jpg`).
        - [ ] Сформировать новый URL/ключ для записи в БД (относительный путь в Minio).
        - [ ] Обновить запись в БД новым URL/ключом.
    - [x] Реализовать логирование процесса и ошибок.
  - [ ] Протестировать скрипт на небольшой выборке данных или в тестовом окружении.
  - [ ] Сделать резервную копию базы данных перед запуском скрипта на боевых данных.
  - [ ] Запустить скрипт миграции.
  - [ ] Проверить корректность миграции: доступность изображений в Minio, правильность URL в БД, отображение в админке и на фронтенде.
- **Зависимости**: Настройка Minio и S3 плагина в Medusa завершена.

## Задача: Развертывание MedusaJS, Minio и Redis на сервере
- **Статус**: В процессе
- **Описание**: Подготовить и выполнить развертывание MedusaJS бэкенда, а также сервисов Minio и Redis (в Docker-контейнерах) на производственном/тестовом сервере. Настроить переменные окружения, Docker Compose, политики доступа Minio и запуск Medusa через менеджер процессов (pm2).
- **Шаги выполнения**:
  - [x] Подготовить сервер (установлены git, node, yarn, docker, docker-compose).
  - [x] Клонирован/обновлен репозиторий проекта на сервере.
  - [ ] Установить зависимости для Medusa бэкенда (`yarn install`).
  - [ ] Собрать проект Medusa, если требуется (`yarn build`).
  - [ ] Создать и настроить файл `.env` для Medusa на сервере (указать `NODE_ENV=production`, параметры БД, Redis, JWT/Cookie секреты, CORS, URL бэкенда, параметры S3/Minio, включая `S3_URL` и `S3_ENDPOINT` для серверного окружения).
  - [x] Создан/адаптирован файл `docker-compose.yml` для запуска Minio и Redis.
  - [x] Запущены контейнеры Minio и Redis через `docker-compose up -d --build`.
  - [x] Устранен конфликт портов для Minio (порт 9001 был занят, изменен на 9000 для API Minio в `docker-compose.yml`, Minio UI доступен по 9001).
  - [ ] Устранить конфликт портов для Redis (порт 6379 занят).
    - [ ] Вариант 1: Остановить существующий сервис Redis на хосте (`sudo systemctl stop redis-server` или `sudo service redis-server stop`).
    - [ ] Вариант 2: Изменить порт для Redis в `docker-compose.yml` (например, на `6380:6379`) и обновить `REDIS_URL` в `.env` Medusa.
  - [ ] Проверить доступность Minio (API на порту 9000, UI на порту 9001) и Redis (на выбранном порту) с хост-машины и изнутри сети Docker.
  - [ ] Настроить политики доступа (CORS, public access) для бакета Minio, если это еще не сделано.
  - [ ] Установить `pm2` глобально (`yarn global add pm2` или `npm install pm2 -g`).
  - [ ] Создать конфигурационный файл для `pm2` (ecosystem.config.js) для Medusa бэкенда.
  - [ ] Запустить Medusa бэкенд через `pm2 start ecosystem.config.js`.
  - [ ] Настроить веб-сервер (Nginx/Apache) как обратный прокси для Medusa бэкенда и Minio (если требуется доступ извне по стандартным портам HTTP/HTTPS).
  - [ ] Провести полное тестирование функционала (загрузка файлов, работа API, админка Medusa).
  - [ ] Задокументировать финальную конфигурацию и шаги развертывания в `docs/project.md`.
- **Зависимости**: Задача "Интеграция Minio через S3-провайдер в MedusaJS".

## Задача: Подключение к PostgreSQL на сервере через pgAdmin
- **Статус**: В процессе
- **Описание**: Настроить PostgreSQL сервер для приема удаленных подключений и подключиться к базе данных проекта Ugodo с помощью pgAdmin для удобного управления и анализа данных. Первоначальная диагностика конфигурации проводится через `psql` на сервере.
- **Шаги выполнения**:
  - [x] Подключиться к PostgreSQL на сервере через `psql` (выявлена ошибка Peer authentication failed for user 'medusa').
  - [x] Определить путь к файлу `pg_hba.conf` (`/etc/postgresql/16/main/pg_hba.conf`).
  - [x] Проанализировать содержимое `pg_hba.conf`: выявлено правило `local all all peer`, вызывающее ошибку.
  - [x] Отредактировать `pg_hba.conf`: добавлена строка `local all medusa md5` ПЕРЕД строкой `local all all peer`.
  - [x] Перезагрузить конфигурацию PostgreSQL (`SELECT pg_reload_conf();`).
  - [x] Успешно подключиться к `psql -d medusa_db -U medusa -W`.
  - [x] Проверены `listen_addresses` (`localhost`) и `port` (`5432`). Путь к `postgresql.conf` предполагается `/etc/postgresql/16/main/postgresql.conf`.
  - [ ] Принять решение о необходимости настройки удаленного доступа для pgAdmin.
  - [ ] Если удаленное подключение через pgAdmin требуется:
    - [ ] Скорректировать `postgresql.conf` (изменить `listen_addresses = 'localhost'` на `listen_addresses = '*'`).
    - [ ] Добавить правило в `pg_hba.conf` для IP-адреса pgAdmin с методом `md5` (например, `host all medusa <IP_pgAdmin>/32 md5`).
    - [ ] Открыть порт PostgreSQL (5432) в брандмауэре сервера для IP-адреса pgAdmin.
    - [ ] Перезапустить/перезагрузить конфигурацию PostgreSQL.
    - [ ] Получить актуальные данные для подключения (адрес сервера `89.108.110.26`, порт `5432`, имя БД `medusa_db`, имя пользователя `medusa`, пароль из `.env`).
    - [ ] Создать новое серверное подключение в pgAdmin.
    - [ ] Проверить успешность подключения и доступ к таблицам.
  - [ ] Обновить документацию `changelog.md` и `tasktracker.md`.
- **Зависимости**: PostgreSQL сервер должен быть установлен и запущен. Имя пользователя БД Medusa - `medusa`, имя БД - `medusa_db`.

## Задача: Настроить регулярное резервное копирование
- **Статус**: Не начата
- **Описание**: Настроить и автоматизировать процесс регулярного резервного копирования базы данных PostgreSQL (medusa_db) и данных Minio (бакет medusa-uploads), если они хранятся на том же сервере, что и ОС. Резервные копии должны сохраняться в безопасное, отдельное от основного сервера, место (например, внешний диск, облачное хранилище).
- **Шаги выполнения**:
  - [ ] Выбрать инструмент и стратегию для резервного копирования PostgreSQL (например, pg_dump + cron/systemd timer).
  - [ ] Выбрать инструмент и стратегию для резервного копирования данных Minio (например, rsync, mc mirror + cron/systemd timer).
  - [ ] Настроить скрипты для автоматического создания резервных копий.
  - [ ] Настроить сохранение резервных копий во внешнее хранилище.
  - [ ] Протестировать процесс восстановления из резервных копий.
  - [ ] Задокументировать процесс резервного копирования и восстановления.
- **Зависимости**: Нет

## Задача: Восстановить оба способа входа/регистрации (SMS и email/пароль)
- **Статус**: Завершена
- **Описание**: Восстановить и реализовать современный UX для входа и регистрации по SMS и по email/паролю. Исправить баги с регистрацией/входом для новых и существующих пользователей. Обеспечить выбор способа входа/регистрации.
- **Шаги выполнения**:
  - [x] Проанализировать текущую реализацию и баги
  - [x] Восстановить форму входа по email/паролю
  - [x] Восстановить форму регистрации по email/паролю
  - [x] Реализовать выбор между SMS и email/пароль
  - [x] Исправить баги с регистрацией/входом
  - [x] Улучшить UX, добавить loader'ы, ошибки, heroUI
  - [x] Обновить changelog и tasktracker
- **Зависимости**: Требует актуальной документации и поддержки Medusa/PerseidesJS Auth-OTP

## Задача: Документирование модуля OTP авторизации
- **Статус**: Завершена
- **Описание**: Документировать кастомный модуль аутентификации по SMS для включения его в общую документацию проекта и API
- **Шаги выполнения**:
  - [x] Изучен код модуля OTP авторизации на бэкенде (Medusa) и фронтенде (Next.js).
  - [x] Определены используемые API эндпоинты: `/store/auth/customer/otp/pre-register`, `/store/auth/customer/otp/register`, `/store/auth/customer/otp/verify`, `/store/auth/customer/otp/authenticate`.
  - [x] Создан файл OpenAPI спецификации `docs/otp_api.yaml` с описанием этих эндпоинтов, их запросов и ответов.
  - [x] Обновлен файл `docs/project.md`: добавлена информация об архитектуре OTP модуля, его компонентах, и ссылка на `docs/otp_api.yaml`.
  - [x] Обновлен `docs/changelog.md`.
- **Зависимости**: Отсутствуют.

## Задача: Исправление путей API для OTP авторизации
- **Статус**: Завершена
- **Описание**: Обнаружена ошибка в путях API для OTP авторизации. Исправлены пути в соответствии с документацией плагина `@perseidesjs/auth-otp`.
- **Шаги выполнения**:
  - [x] Изучена документация плагина `@perseidesjs/auth-otp`
  - [x] Обнаружено, что правильные пути начинаются с `/auth/customer/otp/...` вместо `/store/auth/customer/otp/...`
  - [x] Исправлены JSDoc аннотации для Swagger в файлах `medusa/src/api/routes/store/auth/customer/otp/`
  - [x] Обновлена спецификация OTP API в файле `docs/otp_api.yaml`
  - [x] Обновлена документация проекта с правильными путями
- **Зависимости**: Связано с задачей "Интеграция OTP API в Swagger документацию".

## Задача: Интеграция OTP API в Swagger документацию
- **Статус**: Завершена
- **Описание**: Добавить OTP методы в существующую Swagger документацию для фронтенда и настроить CORS для избежания ошибок при запросах.
- **Шаги выполнения**:
  - [x] Созданы файлы с JSDoc аннотациями для OTP API в `medusa/src/api/routes/store/auth/customer/otp/`.
  - [x] Добавлен тег "Customer OTP Auth" в Swagger спецификацию.
  - [x] Обновлены CORS заголовки для `/doc` и `/doc/storefront`.
  - [x] Добавлены пути для сканирования JSDoc аннотаций в `medusa/src/api/doc/storefront/route.ts`.
- **Зависимости**: Связано с задачей "Документирование модуля OTP авторизации".

## Задача: Подключение полной документации Storefront API
- **Статус**: Завершена
- **Описание**: Подключить полную спецификацию Storefront API из файла `openapi (1).yaml` в Swagger UI для доступа к документации по эндпоинтам `/store/customers`.
- **Шаги выполнения**:
  - [x] Разкомментирован код загрузки внешней спецификации в `medusa/src/api/doc/storefront/route.ts`.
  - [x] Проверено, что документация по `/store/customers` отображается в Swagger UI.
- **Зависимости**: Связано с задачей "Интеграция OTP API в Swagger документацию".

## Задача: Внедрение нового UX и flow SMS-авторизации
- **Статус**: Завершена
- **Описание**: Реализовать современный UX и эталонный flow регистрации/авторизации по SMS: автоматическое создание Customer после register, автогенерация email, современный дизайн формы (heroUI + Tailwind), обработка ошибок (401/409), UX-подсказки.
- **Шаги выполнения**:
  - [x] Проанализировать best practices PerseidesJS, Medusa и UX
  - [x] Реализовать автоматическое создание Customer после register
  - [x] Внедрить автогенерацию email, если не введён
  - [x] Перепроверить передачу токена и обработку ошибок
  - [x] Реализовать современный дизайн формы (heroUI + Tailwind)
  - [x] Обновить документацию и changelog
- **Зависимости**: Требования Medusa к уникальности email, UX стандарты heroUI

## Задача: Полный переход на SMS-only регистрацию/авторизацию
- **Статус**: Завершена
- **Описание**: Удалить все формы и компоненты email/пароль, оставить только SMS OTP flow. Перепроверить передачу publishable key. Обновить документацию и changelog.
- **Шаги выполнения**:
  - [x] Найти и удалить все компоненты email/пароль (login, register, profile-email, profile-password)
  - [x] Перепроверить все переходы и шаблоны
  - [x] Перепроверить передачу publishable key во всех запросах
  - [x] Обновить документацию и changelog
- **Зависимости**: Требования Medusa к publishable key, UX стандарты heroUI

## Задача: Аудит генерации OTP и исправление CORS
- **Статус**: Завершена
- **Описание**: Провести аудит генерации и логирования OTP для любого номера (и для входа, и для регистрации), исправить и перепроверить конфигурацию CORS для всех публичных auth-эндпоинтов, провести code review.
- **Шаги выполнения**:
  - [x] Проверить, что метод register всегда логирует OTP для любого номера (и для входа, и для регистрации).
  - [x] Проверить и исправить конфиг CORS для всех публичных auth-эндпоинтов.
  - [x] Перезапустить backend, проверить работу авторизации.
  - [x] Обновить changelog, tasktracker, project.md.
  - [x] Провести code review изменений.
- **Зависимости**: Нет

## Задача: Исправление генерации и отправки OTP для входа и регистрации
- **Статус**: Завершена
- **Описание**: Исправить логику генерации и отправки OTP — теперь OTP всегда генерируется и отправляется для любого номера (и для входа, и для регистрации), даже если пользователь уже существует. Логика унифицирована, баг устранён.
- **Шаги выполнения**:
  - [x] Проанализировать текущую логику генерации OTP для входа и регистрации.
  - [x] Исправить сервис: OTP всегда генерируется и отправляется, даже если AuthIdentity уже существует.
  - [x] Провести code review и обновить changelog, tasktracker, project.md.
- **Зависимости**: Нет

## Задача: Исправление flow SMS-авторизации (автоматический вызов /verify)
- **Статус**: Завершена
- **Описание**: Исправить flow SMS-авторизации — теперь при ошибке 'Actor already exists' на /pre-register фронтенд автоматически вызывает /verify для генерации и отправки OTP существующему пользователю. Баг устранён, flow соответствует best practice PerseidesJS.
- **Шаги выполнения**:
  - [x] Проанализировать текущий flow и логику PerseidesJS.
  - [x] Исправить компонент LoginSMS: после ошибки на /pre-register вызывать /verify.
  - [x] Провести code review и обновить changelog, tasktracker, project.md.
- **Зависимости**: Нет