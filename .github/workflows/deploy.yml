name: Deploy Ugodo Application

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          
      - name: Build and push Frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ugodo-frontend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Build and push Backend Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./medusa
          file: ./medusa/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/ugodo-backend:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /path/to/ugodo_dev
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            git pull origin main
            
            # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
            sudo -u postgres pg_dump ugodo_db > backup_$(date +%Y%m%d_%H%M%S).sql
            
            # –û–±–Ω–æ–≤–ª—è–µ–º Docker –æ–±—Ä–∞–∑—ã
            docker compose pull
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å zero-downtime
            docker compose up -d --remove-orphans
            
            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
            sleep 30
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å
            curl -f http://localhost:8000 || exit 1
            curl -f http://localhost:9000/store/products || exit 1
            
            # –û—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—Ä–∞–∑–æ–≤
            docker image prune -af 
            docker volume prune -f
            
            echo "‚úÖ Deployment completed successfully!"
            
      - name: Notify on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "‚ùå Deployment failed! Rolling back..."
            cd /path/to/ugodo_dev
            git checkout HEAD~1
            docker compose up -d
            echo "üîÑ Rollback completed" 